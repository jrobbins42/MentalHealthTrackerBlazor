@using MentalHealthTrackerBlazor.Data
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@inject EntryManager EntryManager   

<AuthorizeView>
    <Authorized>
        <h3>Create Mental Health Tracker Entry</h3>

        <form @onsubmit="HandleAddSubmit" class="p-4 border rounded mb-4">
            <div class="row g-3">
                <div class="col-md-2">
                    <label for="date" class="form-label">Date</label>
                    <input type="date" id="date" class="form-control" @bind="newEntry.Date" @bind:format="yyyy-MM-dd" />
                </div>
                <div class="col-md-1">
                    <label for="mood" class="form-label">Mood</label>
                    <input type="number" id="mood" class="form-control" @bind="newEntry.Mood" min="1" max="5" />
                </div>
                <div class="col-md-4">
                    <label for="notes" class="form-label">Notes</label>
                    <input type="text" id="notes" class="form-control" @bind="newEntry.Notes" />
                </div>
                <div class="col-md-4">
                    <label for="triggers" class="form-label">Triggers</label>
                    <input type="text" id="triggers" class="form-control" @bind="newEntry.Triggers" />
                </div>
                <div class="col-md-1 d-flex align-items-end">
                    <button type="submit" class="btn btn-primary w-100">Add</button>
                </div>
            </div>
        </form>

        @if (entries == null)
        {
            <p><em>Loading entries...</em></p>
        }
        else
        {
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Mood</th>
                        <th>Notes</th>
                        <th>Triggers</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var entryItem in entries)
                    {
                        @* Determine if the current row is the one being edited *@
                        bool isCurrentEntryBeingEdited = (editingEntry?.EntryId == entryItem.EntryId);

                        <tr>
                            <td>@entryItem.Date.ToShortDateString()</td>
                    
                            @* Editable Fields (Mood, Notes, Triggers) *@
                            @if (isCurrentEntryBeingEdited)
                            {
                                <td><input type="number" class="form-control form-control-sm" @bind="editingEntry.Mood" min="1" max="5" /></td>
                                <td><textarea class="form-control form-control-sm" @bind="editingEntry.Notes"></textarea></td>
                                <td><textarea class="form-control form-control-sm" @bind="editingEntry.Triggers"></textarea></td>
                            }
                            else
                            {
                                <td>@entryItem.Mood</td>
                                <td>@entryItem.Notes</td>
                                <td>@entryItem.Triggers</td>
                            }
                    
                            <td>
                                @if (isCurrentEntryBeingEdited)
                                {
                                    <button class="btn btn-sm btn-success" @onclick="SaveEntry">Save</button>
                                    <button class="btn btn-sm btn-secondary" @onclick="CancelEdit">Cancel</button>
                                }
                                else
                                {
                                    @* Use entryItem.EntryId to uniquely identify which entry to edit/delete *@
                                    <button class="btn btn-sm btn-warning" @onclick="() => StartEdit(entryItem.EntryId)">Edit</button>
                                    <button class="btn btn-sm btn-danger" @onclick="() => DeleteEntry(entryItem.EntryId,entryItem.UserId)">Delete</button>
                                }
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        }
    </Authorized>
    <NotAuthorized>
        <p>You are not authorized to view this page.</p>
    </NotAuthorized>
</AuthorizeView>


@code {
    // Add a property or field for UserId to resolve CS0103
    private int UserId { get; set; }

    private MentalHealthEntry newEntry = new() { UserId = 1, Date = DateTime.Today, Mood = 3, Notes = string.Empty, Triggers = string.Empty };
    private List<MentalHealthEntry> entries = new();
    // This variable holds the *copy* of the entry currently being edited in the UI
    private MentalHealthEntry editingEntry = null;

   

    protected override void OnInitialized()
    {
        // Initialize UserId with a valid value, e.g., from authentication context or a default
        UserId = 1; // Replace with actual logic to get the current user's ID

        entries = EntryManager.GetEntries(UserId);
    }
    // New: Handler for the Add New Entry Form
    private async Task HandleAddSubmit()
    {
        EntryManager.AddMentalHealthEntry(newEntry, newEntry.UserId);
        ResetAddForm(); // Clear the form fields for the next entry
        LoadEntries(); // Refresh the list
        await InvokeAsync(StateHasChanged);
    }

    // New: Helper to reset the Add form
    private void ResetAddForm()
    {
        newEntry = new() { UserId = 1, Date = DateTime.Today, Mood = 3, Notes = string.Empty, Triggers = string.Empty };
    }

    private void LoadEntries()
    {
        entries = EntryManager.GetEntries(UserId);
    }

    // Original Delete method (remains mostly the same)
    private async Task DeleteEntry(int entryId, int UserId)
    {
        EntryManager.DeleteMentalHealthEntry(entryId, UserId);
        LoadEntries();
        await InvokeAsync(StateHasChanged);
    }

    // New: Method to start the edit process for a specific row
    private void StartEdit(int entryId)
    {
        // Find the original entry
        var entryToEdit = entries.FirstOrDefault(e => e.EntryId == entryId);
        if (entryToEdit != null)
        {
            // Create a *clone* so changes don't update the main table until 'Save' is clicked
            editingEntry = (MentalHealthEntry)entryToEdit.Clone();
        }
    }

    // New: Method to save the changes from the inline inputs
    private async Task SaveEntry()
    {
        if (editingEntry != null)
        {
            EntryManager.UpdateMentalHealthEntry(editingEntry); // Update data store
            CancelEdit(); // Exit edit mode
            LoadEntries(); // Reload the list to refresh the table
            await InvokeAsync(StateHasChanged);
        }
    }

    // New: Helper to cancel the edit and clear the editing state
    private void CancelEdit()
    {
        editingEntry = null;
    }


}
